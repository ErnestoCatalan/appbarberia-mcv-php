let paso=1;const pasoInicial=1,pasoFinal=3,cita={id:"",nombre:"",fecha:"",hora:"",servicios:[]};function iniciarApp(){mostrarSeccion(),tabs(),botonesPaginador(),paginaSiguiente(),paginaAnterior(),consultarAPI(),idCliente(),nombreCliente(),seleccionarFecha(),seleccionarHora(),mostrarResumen()}function mostrarSeccion(){const e=document.querySelector(".mostrar");e&&e.classList.remove("mostrar");const t=`#paso-${paso}`,o=document.querySelector(t);o&&o.classList.add("mostrar");const a=document.querySelector(".actual");a&&a.classList.remove("actual");const r=document.querySelector(`[data-paso="${paso}"]`);r&&r.classList.add("actual")}function tabs(){document.querySelectorAll(".tabs button").forEach((e=>{e.addEventListener("click",(function(e){paso=parseInt(e.target.dataset.paso),mostrarSeccion(),botonesPaginador()}))}))}function botonesPaginador(){const e=document.querySelector("#anterior"),t=document.querySelector("#siguiente");1===paso?(e&&e.classList.add("ocultar"),t&&t.classList.remove("ocultar")):3===paso?(e&&e.classList.remove("ocultar"),t&&t.classList.add("ocultar"),mostrarResumen()):(e&&e.classList.remove("ocultar"),t&&t.classList.remove("ocultar")),mostrarSeccion()}function paginaSiguiente(){const e=document.querySelector("#siguiente");e&&e.addEventListener("click",(function(){paso>=3||(paso++,botonesPaginador())}))}function paginaAnterior(){const e=document.querySelector("#anterior");e&&e.addEventListener("click",(function(){paso<=1||(paso--,botonesPaginador())}))}async function consultarAPI(){const e=document.querySelector("#barberia_id")?.value;if(e)try{const t=`${location.origin}/api/servicios?barberia_id=${e}`,o=await fetch(t);mostrarServicios(await o.json())}catch(e){console.log("Error al consultar API:",e)}else console.error("No hay barbería seleccionada")}function mostrarServicios(e){const t=document.querySelector("#servicios");t&&(t.innerHTML="",e.forEach((e=>{const{id:o,nombre:a,precio:r,descripcion:n="",duracion:i=30,imagen:c=""}=e,s=document.createElement("DIV");s.classList.add("servicio-cita"),s.dataset.idServicio=o,s.addEventListener("click",(function(){seleccionarServicio(e)}));let l="";l=c?`<img src="/uploads/servicios/${c}" \n                             alt="${a}"\n                             onerror="this.onerror=null; this.src='/build/img/servicio-default.jpg';">`:`<img src="/build/img/servicio-default.jpg" alt="${a}">`,s.innerHTML=`\n            <div class="servicio-imagen-cita">\n                ${l}\n            </div>\n            <div class="servicio-info-cita">\n                <h3>${a}</h3>\n                ${n?`<p class="descripcion-servicio">${n}</p>`:""}\n                <p class="precio-servicio">$${parseFloat(r).toFixed(2)}</p>\n                <p class="duracion-servicio">\n                    <i class="fas fa-clock"></i> ${i} minutos\n                </p>\n            </div>\n        `,t.appendChild(s)})))}function seleccionarServicio(e){if(!e||!e.id)return;const{id:t}=e,{servicios:o}=cita,a=document.querySelector(`[data-id-servicio="${t}"]`);if(!a)return;const r=o.findIndex((e=>e.id===t));r>-1?(cita.servicios.splice(r,1),a.classList.remove("seleccionado")):(cita.servicios.push(e),a.classList.add("seleccionado")),console.log("Cita actual:",cita)}function idCliente(){const e=document.querySelector("#id");e&&(cita.id=e.value)}function nombreCliente(){const e=document.querySelector("#nombre");e&&(cita.nombre=e.value)}function seleccionarFecha(){const e=document.querySelector("#fecha");e&&e.addEventListener("input",(function(e){const t=e.target.value;if(!t)return;const o=new Date(t).getUTCDay();[4,0].includes(o)?(e.target.value="",mostrarAlerta("Jueves y Domingos No Disponibles","error",".formulario")):cita.fecha=t}))}function seleccionarHora(){const e=document.querySelector("#hora");e&&e.addEventListener("input",(function(e){const t=e.target.value;if(!t)return;const o=parseInt(t.split(":")[0]);o<9||o>19?(e.target.value="",mostrarAlerta("Hora No Válida","error",".formulario")):cita.hora=t}))}function mostrarAlerta(e,t,o,a=!0){const r=document.querySelector(".alerta");r&&r.remove();const n=document.createElement("DIV");n.textContent=e,n.classList.add("alerta"),n.classList.add(t);const i=document.querySelector(o);i&&(i.appendChild(n),a&&setTimeout((()=>{n.remove()}),3e3))}function mostrarResumen(){const e=document.querySelector(".contenido-resumen");if(!e)return;const t=document.querySelector("#barberia_id")?.value;if(e.innerHTML="",t&&(cita.barberia_id=t),!(cita.nombre&&cita.fecha&&cita.hora&&0!==cita.servicios.length&&cita.barberia_id)){const e=[];return cita.nombre||e.push("Nombre del cliente"),cita.fecha||e.push("Fecha"),cita.hora||e.push("Hora"),0===cita.servicios.length&&e.push("Al menos un servicio"),cita.barberia_id||e.push("Barbería"),void mostrarAlerta(`Faltan datos: ${e.join(", ")}`,"error",".contenido-resumen",!1)}const{nombre:o,fecha:a,hora:r,servicios:n}=cita,i=document.createElement("H3");i.textContent="Resumen de Servicios",e.appendChild(i),n.forEach((t=>{const{id:o,precio:a,nombre:r,descripcion:n="",duracion:i=30,imagen:c=""}=t,s=document.createElement("DIV");s.classList.add("contenedor-servicio");const l=document.createElement("P");if(l.textContent=r,n){const e=document.createElement("P");e.textContent=n,e.style.fontSize="1.4rem",e.style.color="rgba(255, 255, 255, 0.7)",e.style.marginTop="0.5rem",s.appendChild(e)}const d=document.createElement("P");d.innerHTML=`<span>Precio:</span> $${parseFloat(a).toFixed(2)}`;const u=document.createElement("P");u.innerHTML=`<span>Duración:</span> ${i} minutos`,s.appendChild(l),s.appendChild(d),s.appendChild(u),e.appendChild(s)}));const c=document.createElement("H3");c.textContent="Resumen de Cita",e.appendChild(c);const s=document.createElement("P");s.innerHTML=`<span>Nombre:</span> ${o}`;const l=new Date(a),d=l.getMonth(),u=l.getDate()+2,m=l.getFullYear(),p=new Date(Date.UTC(m,d,u)).toLocaleDateString("es-MX",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),v=document.createElement("P");v.innerHTML=`<span>Fecha:</span> ${p}`;const f=document.createElement("P");f.innerHTML=`<span>Hora:</span> ${r} Horas`;const h=n.reduce(((e,t)=>e+parseFloat(t.precio)),0),b=document.createElement("P");b.innerHTML=`<span>Total:</span> $${h.toFixed(2)}`,b.style.fontSize="2rem",b.style.color="#4caf50",b.style.fontWeight="bold",b.style.marginTop="1rem";const g=document.createElement("BUTTON");g.classList.add("boton"),g.textContent="Reservar Cita",g.onclick=reservarCita,e.appendChild(s),e.appendChild(v),e.appendChild(f),e.appendChild(b),e.appendChild(g)}async function reservarCita(){const{nombre:e,fecha:t,hora:o,servicios:a,id:r}=cita,n=document.querySelector("#barberia_id")?.value;if(!n||!t||!o||0===a.length)return void mostrarAlerta("Faltan datos de Servicios, Fecha u Hora","error",".contenido-resumen",!1);const i=a.map((e=>e.id)),c=new FormData;c.append("fecha",t),c.append("hora",o),c.append("servicios",i.join(",")),c.append("barberia_id",n),console.log("Enviando datos para crear cita:",{fecha:t,hora:o,servicios:i,barberia_id:n});try{const e=`${location.origin}/api/citas`,t=await fetch(e,{method:"POST",body:c}),o=await t.text();let a;console.log("Respuesta del servidor (raw):",o.substring(0,500));try{a=JSON.parse(o)}catch(e){if(console.error("Error parseando JSON:",e),console.error("Respuesta completa:",o),t.ok)return void await mostrarExitoYCargarCitas();throw new Error("El servidor devolvió una respuesta no válida. Verifica los logs.")}if(console.log("Respuesta del servidor (parsed):",a),!a.resultado)throw new Error(a.error||"Error al crear cita");await mostrarExitoYCargarCitas()}catch(e){console.error("Error completo:",e),Swal.fire({icon:"error",title:"Error",html:`Hubo un error al guardar la cita.<br><br>\n                   <small style="font-size: 0.8em; color: #666;">\n                   Detalles: ${e.message}<br>\n                   Nota: La cita puede haberse creado exitosamente. \n                   Verifica en "Mis Citas".\n                   </small>`,confirmButtonText:"Entendido"})}}async function mostrarExitoYCargarCitas(){await Swal.fire({icon:"success",title:"Cita Creada",text:"Tu cita fue creada correctamente",confirmButtonText:"Ver Mis Citas",showCancelButton:!0,cancelButtonText:"Crear Otra Cita"}).then((e=>{e.isConfirmed?window.location.href="/cita?exito=1":window.location.reload()}))}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));